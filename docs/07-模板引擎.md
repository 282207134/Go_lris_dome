# 07 - 模板引擎

## 模板引擎概述

Iris 内置了强大的模板引擎支持，包括 HTML、Pug（Jade）、Handlebars、Amber 等多种模板格式。模板引擎允许将动态数据插入到静态模板中，生成动态网页内容。

## HTML 模板引擎

### 1. 基本配置

```go
func setupHTMLTemplates(app *iris.Application) {
    // 基本HTML模板配置
    tmpl := iris.HTML("./templates", ".html")
    
    // 注册模板引擎
    app.RegisterView(tmpl)
    
    // 使用布局
    tmpl.Layout("layouts/layout.html")
    
    // 添加模板函数
    tmpl.AddFunc("formatTime", func(t time.Time) string {
        return t.Format("2006-01-02 15:04:05")
    })
    
    tmpl.AddFunc("formatDate", func(t time.Time) string {
        return t.Format("2006-01-02")
    })
    
    tmpl.AddFunc("truncate", func(text string, length int) string {
        if len(text) <= length {
            return text
        }
        return text[:length] + "..."
    })
    
    tmpl.AddFunc("upper", func(text string) string {
        return strings.ToUpper(text)
    })
    
    tmpl.AddFunc("lower", func(text string) string {
        return strings.ToLower(text)
    })
}
```

### 2. 渲染模板

```go
func renderTemplate(ctx iris.Context) {
    // 设置模板数据
    ctx.ViewData("title", "Iris 模板示例")
    ctx.ViewData("message", "欢迎使用 Iris 模板引擎")
    
    // 设置复杂数据
    user := map[string]interface{}{
        "name":  "张三",
        "email": "zhangsan@example.com",
        "age":   25,
        "avatar": "/images/avatar.jpg",
    }
    ctx.ViewData("user", user)
    
    // 设置列表数据
    posts := []map[string]interface{}{
        {"id": 1, "title": "第一篇文章", "content": "这是第一篇文章的内容", "created_at": time.Now()},
        {"id": 2, "title": "第二篇文章", "content": "这是第二篇文章的内容", "created_at": time.Now().Add(-24 * time.Hour)},
        {"id": 3, "title": "第三篇文章", "content": "这是第三篇文章的内容", "created_at": time.Now().Add(-48 * time.Hour)},
    }
    ctx.ViewData("posts", posts)
    
    // 渲染模板
    ctx.View("index.html")
}

func renderWithLayout(ctx iris.Context) {
    // 使用布局渲染模板
    ctx.ViewData("title", "带布局的页面")
    ctx.ViewData("content", "这是页面的主要内容")
    ctx.ViewData("sidebar", "这是侧边栏内容")
    
    // 指定布局
    ctx.ViewLayout("layouts/main.html")
    ctx.View("content.html")
}
```

### 3. 模板继承

```go
// layouts/base.html - 基础布局模板
const baseLayout = `
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.title}}</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <header>
        <h1>网站标题</h1>
        <nav>
            <ul>
                <li><a href="/">首页</a></li>
                <li><a href="/about">关于</a></li>
                <li><a href="/contact">联系</a></li>
            </ul>
        </nav>
    </header>
    
    <main>
        {{template "content" .}}
    </main>
    
    <footer>
        <p>&copy; 2023 Iris 示例项目</p>
    </footer>
    
    <script src="/static/js/app.js"></script>
</body>
</html>
`

// layouts/admin.html - 管理员布局模板
const adminLayout = `
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.title}} - 管理后台</title>
    <link rel="stylesheet" href="/static/css/admin.css">
</head>
<body>
    <div class="admin-layout">
        <aside class="sidebar">
            <h3>管理菜单</h3>
            <ul>
                <li><a href="/admin/dashboard">仪表板</a></li>
                <li><a href="/admin/users">用户管理</a></li>
                <li><a href="/admin/posts">文章管理</a></li>
                <li><a href="/admin/settings">系统设置</a></li>
            </ul>
        </aside>
        
        <main class="main-content">
            <header class="admin-header">
                <h2>{{.title}}</h2>
                <div class="user-info">
                    欢迎，{{.user.name}}
                </div>
            </header>
            
            {{template "content" .}}
        </main>
    </div>
</body>
</html>
`

func setupTemplateLayouts(app *iris.Application) {
    // 注册基础布局
    tmpl := iris.HTML("./templates", ".html")
    tmpl.Layout("layouts/base.html") // 默认布局
    
    // 为不同路由组设置不同布局
    web := app.Party("/")
    web.Use(func(ctx iris.Context) {
        ctx.ViewLayout("layouts/base.html")
        ctx.Next()
    })
    
    admin := app.Party("/admin")
    admin.Use(func(ctx iris.Context) {
        ctx.ViewLayout("layouts/admin.html")
        ctx.Next()
    })
    
    app.RegisterView(tmpl)
}
```

## 模板语法

### 1. 变量输出

```html
<!-- 基本变量输出 -->
<h1>{{.title}}</h1>
<p>{{.message}}</p>

<!-- 嵌套变量 -->
<p>用户名：{{.user.name}}</p>
<p>邮箱：{{.user.email}}</p>

<!-- 带默认值 -->
<p>年龄：{{.user.age | default "未知"}}</p>

<!-- HTML 转义 -->
<p>{{.content}}</p> <!-- 转义 HTML -->
<p>{{.content | html}}</p> <!-- 不转义 HTML -->

<!-- 函数调用 -->
<p>格式化时间：{{.created_at | formatTime}}</p>
<p>截断文本：{{.content | truncate 50}}</p>
<p>转大写：{{.title | upper}}</p>
```

### 2. 条件语句

```html
<!-- if 语句 -->
{{if .user}}
    <p>欢迎，{{.user.name}}！</p>
{{else}}
    <p>请先登录</p>
{{end}}

<!-- 多条件判断 -->
{{if eq .user.role "admin"}}
    <p>管理员权限</p>
{{else if eq .user.role "editor"}}
    <p>编辑权限</p>
{{else}}
    <p>普通用户权限</p>
{{end}}

<!-- 复杂条件 -->
{{if and .user .user.active}}
    <p>用户已激活</p>
{{end}}

{{if or .is_admin .is_moderator}}
    <p>有管理权限</p>
{{end}}

{{if not .error}}
    <p>操作成功</p>
{{end}}
```

### 3. 循环语句

```html
<!-- 基本循环 -->
<ul>
{{range .posts}}
    <li>{{.title}} - {{.created_at | formatDate}}</li>
{{end}}
</ul>

<!-- 带索引的循环 -->
<table>
{{range $index, $post := .posts}}
    <tr>
        <td>{{$index}}</td>
        <td>{{$post.title}}</td>
        <td>{{$post.content | truncate 100}}</td>
    </tr>
{{end}}
</table>

<!-- 循环中的条件判断 -->
{{range .users}}
    {{if .active}}
        <div class="user active">
            <h3>{{.name}}</h3>
            <p>{{.email}}</p>
        </div>
    {{else}}
        <div class="user inactive">
            <h3>{{.name}} (未激活)</h3>
            <p>{{.email}}</p>
        </div>
    {{end}}
{{end}}

<!-- 空值处理 -->
{{range .items}}
    <div class="item">{{.name}}</div>
{{else}}
    <p>暂无数据</p>
{{end}}
```

### 4. 模板包含

```html
<!-- 包含其他模板 -->
{{template "header.html" .}}

<main>
    <h1>{{.title}}</h1>
    <div class="content">
        {{template "content.html" .}}
    </div>
</main>

{{template "footer.html" .}}

<!-- 带参数的模板包含 -->
{{template "user_card.html" (dict "user" .user "show_email" true)}}
```

## 高级模板功能

### 1. 自定义模板函数

```go
func setupCustomFunctions(app *iris.Application) {
    tmpl := iris.HTML("./templates", ".html")
    
    // 字符串处理函数
    tmpl.AddFunc("substr", func(text string, start, length int) string {
        if len(text) <= start {
            return ""
        }
        if len(text) <= start+length {
            return text[start:]
        }
        return text[start:start+length]
    })
    
    // 数字格式化函数
    tmpl.AddFunc("numberFormat", func(number float64, decimals int) string {
        format := fmt.Sprintf("%%.%df", decimals)
        return fmt.Sprintf(format, number)
    })
    
    // 时间相对格式化
    tmpl.AddFunc("timeAgo", func(t time.Time) string {
        duration := time.Since(t)
        if duration < time.Minute {
            return "刚刚"
        } else if duration < time.Hour {
            return fmt.Sprintf("%d分钟前", int(duration.Minutes()))
        } else if duration < 24*time.Hour {
            return fmt.Sprintf("%d小时前", int(duration.Hours()))
        } else {
            return fmt.Sprintf("%d天前", int(duration.Hours()/24))
        }
    })
    
    // URL 生成函数
    tmpl.AddFunc("url", func(routeName string, params ...interface{}) string {
        // 根据 routeName 和参数生成 URL
        return "/" + routeName // 简化实现
    })
    
    // 资源版本化函数
    tmpl.AddFunc("asset", func(path string) string {
        // 为静态资源添加版本号
        version := "123456" // 实际应该从文件修改时间或哈希生成
        return path + "?v=" + version
    })
    
    // 条件类名函数
    tmpl.AddFunc("classIf", func(condition bool, className string) string {
        if condition {
            return className
        }
        return ""
    })
    
    // 数组/切片操作函数
    tmpl.AddFunc("join", func(items []string, separator string) string {
        return strings.Join(items, separator)
    })
    
    tmpl.AddFunc("contains", func(slice []string, item string) bool {
        for _, s := range slice {
            if s == item {
                return true
            }
        }
        return false
    })
    
    app.RegisterView(tmpl)
}
```

### 2. 模板数据结构

```go
// 定义模板数据结构
type TemplateData struct {
    Title       string                 `json:"title"`
    Message     string                 `json:"message"`
    User        *User                  `json:"user"`
    Posts       []*Post                `json:"posts"`
    Pagination  *PaginationInfo        `json:"pagination"`
    Flash       map[string]interface{} `json:"flash"`
    Errors      map[string]string      `json:"errors"`
    Config      map[string]interface{} `json:"config"`
    RequestID   string                 `json:"request_id"`
    Timestamp   time.Time              `json:"timestamp"`
}

type User struct {
    ID       int       `json:"id"`
    Name     string    `json:"name"`
    Email    string    `json:"email"`
    Avatar   string    `json:"avatar"`
    Role     string    `json:"role"`
    Active   bool      `json:"active"`
    CreatedAt time.Time `json:"created_at"`
}

type Post struct {
    ID        int       `json:"id"`
    Title     string    `json:"title"`
    Content   string    `json:"content"`
    Author    *User     `json:"author"`
    Tags      []string  `json:"tags"`
    CreatedAt time.Time `json:"created_at"`
    UpdatedAt time.Time `json:"updated_at"`
}

type PaginationInfo struct {
    Current   int   `json:"current"`
    PageSize  int   `json:"page_size"`
    Total     int64 `json:"total"`
    TotalPage int   `json:"total_page"`
    HasPrev   bool  `json:"has_prev"`
    HasNext   bool  `json:"has_next"`
}

func renderComplexTemplate(ctx iris.Context) {
    // 准备模板数据
    data := &TemplateData{
        Title:     "复杂模板示例",
        Message:   "展示复杂的数据结构",
        RequestID: ctx.Values().GetStringDefault("request_id", ""),
        Timestamp: time.Now(),
        Config: map[string]interface{}{
            "site_name": "Iris 示例",
            "version":   "1.0.0",
            "debug":     true,
        },
    }
    
    // 设置用户数据
    data.User = &User{
        ID:       1,
        Name:     "张三",
        Email:    "zhangsan@example.com",
        Avatar:   "/images/avatar.jpg",
        Role:     "admin",
        Active:   true,
        CreatedAt: time.Now().Add(-30 * 24 * time.Hour),
    }
    
    // 设置文章数据
    data.Posts = []*Post{
        {
            ID:      1,
            Title:   "第一篇文章",
            Content: "这是第一篇文章的详细内容...",
            Author:  data.User,
            Tags:    []string{"技术", "Go", "Web"},
            CreatedAt: time.Now().Add(-24 * time.Hour),
            UpdatedAt: time.Now().Add(-12 * time.Hour),
        },
        {
            ID:      2,
            Title:   "第二篇文章",
            Content: "这是第二篇文章的详细内容...",
            Author:  data.User,
            Tags:    []string{"教程", "Iris", "框架"},
            CreatedAt: time.Now().Add(-48 * time.Hour),
            UpdatedAt: time.Now().Add(-6 * time.Hour),
        },
    }
    
    // 设置分页信息
    data.Pagination = &PaginationInfo{
        Current:   1,
        PageSize:  10,
        Total:     25,
        TotalPage: 3,
        HasPrev:   false,
        HasNext:   true,
    }
    
    // 设置 Flash 消息
    data.Flash = map[string]interface{}{
        "success": "操作成功完成",
        "info":    "请注意查看新功能",
    }
    
    // 设置错误信息
    data.Errors = map[string]string{
        "username": "用户名不能为空",
        "email":    "邮箱格式不正确",
    }
    
    // 渲染模板
    ctx.ViewData("data", data)
    ctx.View("complex.html")
}
```

## 模板示例

### 1. 用户列表模板

```html
<!-- templates/users/list.html -->
{{template "header.html" .}}

<div class="users-list">
    <div class="header">
        <h1>用户列表</h1>
        <a href="/users/create" class="btn btn-primary">创建用户</a>
    </div>
    
    {{if .flash.success}}
    <div class="alert alert-success">
        {{.flash.success}}
    </div>
    {{end}}
    
    {{if .flash.error}}
    <div class="alert alert-error">
        {{.flash.error}}
    </div>
    {{end}}
    
    <div class="filters">
        <form method="GET" class="filter-form">
            <input type="text" name="search" placeholder="搜索用户..." value="{{.search}}">
            <select name="role">
                <option value="">所有角色</option>
                <option value="admin" {{if eq .role "admin"}}selected{{end}}>管理员</option>
                <option value="user" {{if eq .role "user"}}selected{{end}}>普通用户</option>
            </select>
            <button type="submit" class="btn btn-secondary">筛选</button>
        </form>
    </div>
    
    <div class="table-container">
        <table class="table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>头像</th>
                    <th>姓名</th>
                    <th>邮箱</th>
                    <th>角色</th>
                    <th>状态</th>
                    <th>注册时间</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody>
                {{range .users}}
                <tr>
                    <td>{{.ID}}</td>
                    <td>
                        <img src="{{.Avatar}}" alt="{{.Name}}" class="avatar" width="40" height="40">
                    </td>
                    <td>{{.Name}}</td>
                    <td>{{.Email}}</td>
                    <td>
                        <span class="role role-{{.Role}}">
                            {{if eq .Role "admin"}}管理员{{else}}普通用户{{end}}
                        </span>
                    </td>
                    <td>
                        <span class="status status-{{if .Active}}active{{else}}inactive{{end}}">
                            {{if .Active}}激活{{else}}禁用{{end}}
                        </span>
                    </td>
                    <td>{{.CreatedAt | formatDate}}</td>
                    <td>
                        <a href="/users/{{.ID}}" class="btn btn-sm btn-primary">查看</a>
                        <a href="/users/{{.ID}}/edit" class="btn btn-sm btn-secondary">编辑</a>
                        <a href="/users/{{.ID}}/delete" class="btn btn-sm btn-danger" 
                           onclick="return confirm('确定要删除这个用户吗？')">删除</a>
                    </td>
                </tr>
                {{else}}
                <tr>
                    <td colspan="8" class="text-center">暂无用户数据</td>
                </tr>
                {{end}}
            </tbody>
        </table>
    </div>
    
    {{if .pagination}}
    <div class="pagination">
        {{if .pagination.HasPrev}}
        <a href="?page={{sub .pagination.Current 1}}" class="btn btn-secondary">上一页</a>
        {{end}}
        
        <span class="page-info">
            第 {{.pagination.Current}} 页，共 {{.pagination.TotalPage}} 页
        </span>
        
        {{if .pagination.HasNext}}
        <a href="?page={{add .pagination.Current 1}}" class="btn btn-secondary">下一页</a>
        {{end}}
    </div>
    {{end}}
</div>

{{template "footer.html" .}}
```

### 2. 文章详情模板

```html
<!-- templates/posts/detail.html -->
{{template "header.html" .}}

<article class="post-detail">
    <header class="post-header">
        <h1 class="post-title">{{.post.Title}}</h1>
        <div class="post-meta">
            <span class="author">
                <img src="{{.post.Author.Avatar}}" alt="{{.post.Author.Name}}" width="24" height="24">
                {{.post.Author.Name}}
            </span>
            <span class="date">
                <i class="icon-calendar"></i>
                {{.post.CreatedAt | formatDate}}
            </span>
            {{if ne .post.CreatedAt .post.UpdatedAt}}
            <span class="updated">
                <i class="icon-edit"></i>
                更新于 {{.post.UpdatedAt | formatDate}}
            </span>
            {{end}}
            <span class="views">
                <i class="icon-eye"></i>
                {{.post.Views}} 次浏览
            </span>
        </div>
    </header>
    
    {{if .post.Tags}}
    <div class="post-tags">
        {{range .post.Tags}}
        <span class="tag">{{.}}</span>
        {{end}}
    </div>
    {{end}}
    
    <div class="post-content">
        {{.post.Content | html}}
    </div>
    
    <footer class="post-footer">
        <div class="actions">
            <button class="btn btn-primary" onclick="likePost({{.post.ID}})">
                <i class="icon-heart"></i> 喜欢 ({{.post.Likes}})
            </button>
            <button class="btn btn-secondary" onclick="sharePost({{.post.ID}})">
                <i class="icon-share"></i> 分享
            </button>
            <a href="/posts/{{.post.ID}}/edit" class="btn btn-secondary">
                <i class="icon-edit"></i> 编辑
            </a>
        </div>
        
        <div class="navigation">
            {{if .prevPost}}
            <a href="/posts/{{.prevPost.ID}}" class="prev-post">
                <i class="icon-arrow-left"></i>
                {{.prevPost.Title}}
            </a>
            {{end}}
            
            {{if .nextPost}}
            <a href="/posts/{{.nextPost.ID}}" class="next-post">
                {{.nextPost.Title}}
                <i class="icon-arrow-right"></i>
            </a>
            {{end}}
        </div>
    </footer>
</article>

<section class="comments-section">
    <h3>评论 ({{len .comments}})</h3>
    
    {{if .user}}
    <form class="comment-form" method="POST" action="/posts/{{.post.ID}}/comments">
        <div class="form-group">
            <textarea name="content" placeholder="写下你的评论..." required></textarea>
        </div>
        <button type="submit" class="btn btn-primary">发表评论</button>
    </form>
    {{else}}
    <div class="login-prompt">
        <p>请<a href="/login">登录</a>后发表评论</p>
    </div>
    {{end}}
    
    <div class="comments-list">
        {{range .comments}}
        <div class="comment">
            <div class="comment-header">
                <img src="{{.User.Avatar}}" alt="{{.User.Name}}" width="32" height="32">
                <div class="comment-meta">
                    <span class="author">{{.User.Name}}</span>
                    <span class="date">{{.CreatedAt | timeAgo}}</span>
                </div>
            </div>
            <div class="comment-content">
                {{.Content}}
            </div>
            <div class="comment-actions">
                <button onclick="replyComment({{.ID}})">回复</button>
                {{if eq .User.ID $.user.ID}}
                <button onclick="editComment({{.ID}})">编辑</button>
                <button onclick="deleteComment({{.ID}})">删除</button>
                {{end}}
            </div>
        </div>
        {{else}}
        <p class="no-comments">暂无评论，快来发表第一条评论吧！</p>
        {{end}}
    </div>
</section>

{{template "footer.html" .}}
```

## 模板优化

### 1. 模板缓存

```go
func setupTemplateCache(app *iris.Application) {
    tmpl := iris.HTML("./templates", ".html")
    
    // 启用模板缓存
    tmpl.Reload(false) // 生产环境设为 false
    
    // 开发环境可以设置为 true 以便热重载
    if app.ConfigurationReadOnly().GetEnvironment() == "development" {
        tmpl.Reload(true)
    }
    
    // 设置模板缓存大小
    tmpl.SetCacheSize(100)
    
    app.RegisterView(tmpl)
}
```

### 2. 模板预编译

```go
func precompileTemplates() {
    // 预编译模板以提高性能
    templateFiles := []string{
        "index.html",
        "users/list.html",
        "users/detail.html",
        "posts/list.html",
        "posts/detail.html",
        "layouts/base.html",
        "layouts/admin.html",
    }
    
    for _, file := range templateFiles {
        // 预编译模板
        _, err := iris.HTML("./templates", ".html").Parse(file)
        if err != nil {
            log.Printf("预编译模板失败 %s: %v", file, err)
        } else {
            log.Printf("预编译模板成功: %s", file)
        }
    }
}
```

## 最佳实践

### 1. 模板组织

```
templates/
├── layouts/           # 布局模板
│   ├── base.html     # 基础布局
│   ├── admin.html    # 管理后台布局
│   └── minimal.html  # 简化布局
├── partials/         # 部分模板
│   ├── header.html   # 页头
│   ├── footer.html   # 页脚
│   ├── sidebar.html  # 侧边栏
│   └── user_card.html # 用户卡片
├── users/            # 用户相关模板
│   ├── list.html     # 用户列表
│   ├── detail.html   # 用户详情
│   ├── create.html   # 创建用户
│   └── edit.html     # 编辑用户
├── posts/            # 文章相关模板
│   ├── list.html     # 文章列表
│   ├── detail.html   # 文章详情
│   ├── create.html   # 创建文章
│   └── edit.html     # 编辑文章
└── errors/           # 错误页面
    ├── 404.html      # 页面不存在
    ├── 500.html      # 服务器错误
    └── maintenance.html # 维护页面
```

### 2. 数据传递规范

```go
// 统一的模板数据结构
type ViewData struct {
    Title       string                 `json:"title"`
    Description string                 `json:"description"`
    Keywords    string                 `json:"keywords"`
    User        *User                  `json:"user"`
    Flash       map[string]interface{} `json:"flash"`
    Errors      map[string]string      `json:"errors"`
    Data        map[string]interface{} `json:"data"`
    Config      map[string]interface{} `json:"config"`
}

func renderView(ctx iris.Context, template string, data *ViewData) {
    // 设置通用数据
    if data.User == nil {
        if userID := ctx.Values().GetUintDefault("user_id", 0); userID > 0 {
            // 从数据库获取用户信息
            data.User = getUserByID(userID)
        }
    }
    
    // 设置 Flash 消息
    if flash := getFlashMessages(ctx); len(flash) > 0 {
        data.Flash = flash
    }
    
    // 设置配置信息
    data.Config = getConfig()
    
    // 渲染模板
    ctx.ViewData("view", data)
    ctx.View(template)
}
```

## 下一步

现在您已经掌握了模板引擎的各种技巧，建议继续学习：

1. [数据库集成](./08-数据库集成.md) - 学习数据库操作
2. [身份验证](./09-身份验证.md) - 掌握认证授权
3. [错误处理](./10-错误处理.md) - 学习错误处理机制

## 相关资源

- [Iris 模板引擎文档](https://iris-go.com/views)
- [Go template 包文档](https://golang.org/pkg/html/template/)
- [模板最佳实践](https://github.com/avelino/awesome-go#template-engines)