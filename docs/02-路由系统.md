# 02 - 路由系统

## 路由系统概述

Iris 提供了强大而灵活的路由系统，支持多种路由模式和参数处理。路由是 Web 应用的核心，它将 HTTP 请求映射到相应的处理函数。

## 基本路由

### 1. HTTP 方法路由

Iris 支持所有标准的 HTTP 方法：

```go
// GET 请求
app.Get("/", func(ctx iris.Context) {
    ctx.WriteString("Hello, World!")
})

// POST 请求
app.Post("/users", func(ctx iris.Context) {
    ctx.WriteString("创建用户")
})

// PUT 请求
app.Put("/users/{id}", func(ctx iris.Context) {
    ctx.WriteString("更新用户")
})

// DELETE 请求
app.Delete("/users/{id}", func(ctx iris.Context) {
    ctx.WriteString("删除用户")
})

// PATCH 请求
app.Patch("/users/{id}", func(ctx iris.Context) {
    ctx.WriteString("部分更新用户")
})

// OPTIONS 请求
app.Options("/users", func(ctx iris.Context) {
    ctx.WriteString("获取支持的 HTTP 方法")
})

// HEAD 请求
app.Head("/users", func(ctx iris.Context) {
    ctx.StatusCode(iris.StatusOK)
})
```

### 2. Handle 方法

可以使用 `Handle` 方法注册路由：

```go
// 使用 Handle 方法
app.Handle("GET", "/api/hello", func(ctx iris.Context) {
    ctx.JSON(iris.Map{"message": "Hello, World!"})
})

// 支持多个 HTTP 方法
app.HandleMany("GET POST", "/api/data", func(ctx iris.Context) {
    method := ctx.Method()
    ctx.JSON(iris.Map{"method": method, "message": "Data endpoint"})
})
```

## 路由参数

### 1. 路径参数

```go
// 基本参数
app.Get("/users/{id}", func(ctx iris.Context) {
    id := ctx.Params().Get("id")
    ctx.WriteString("用户 ID: " + id)
})

// 类型化参数
app.Get("/users/{id:int}", func(ctx iris.Context) {
    id, err := ctx.Params().GetInt("id")
    if err != nil {
        ctx.StatusCode(iris.StatusBadRequest)
        ctx.WriteString("无效的 ID")
        return
    }
    ctx.WriteString("用户 ID: " + fmt.Sprintf("%d", id))
})

// 字符串参数
app.Get("/posts/{title:string}", func(ctx iris.Context) {
    title := ctx.Params().GetString("title")
    ctx.WriteString("文章标题: " + title)
})

// 邮箱参数
app.Get("/users/{email:email}", func(ctx iris.Context) {
    email := ctx.Params().GetString("email")
    ctx.WriteString("用户邮箱: " + email)
})
```

### 2. 通配符参数

```go
// 匹配所有路径
app.Get("/files/{path:path}", func(ctx iris.Context) {
    path := ctx.Params().Get("path")
    ctx.WriteString("文件路径: " + path)
})

// 匹配单个段
app.Get("/images/{name:alphabetical}", func(ctx iris.Context) {
    name := ctx.Params().Get("name")
    ctx.WriteString("图片名称: " + name)
})
```

### 3. 可选参数

```go
// 可选参数（需要自定义处理）
app.Get("/users/{id:int}/posts/{post_id:int}", func(ctx iris.Context) {
    userID, _ := ctx.Params().GetInt("id")
    postID, _ := ctx.Params().GetInt("post_id")
    ctx.WriteString(fmt.Sprintf("用户 %d 的文章 %d", userID, postID))
})
```

## 查询参数

### 1. 获取查询参数

```go
app.Get("/search", func(ctx iris.Context) {
    // 获取单个查询参数
    keyword := ctx.URLParam("keyword")
    
    // 带默认值的查询参数
    page := ctx.URLParamDefault("page", "1")
    limit := ctx.URLParamDefault("limit", "10")
    
    // 获取所有查询参数
    allParams := ctx.URLParams()
    
    ctx.JSON(iris.Map{
        "keyword": keyword,
        "page":    page,
        "limit":   limit,
        "all":     allParams,
    })
})
```

### 2. 查询参数数组

```go
app.Get("/filter", func(ctx iris.Context) {
    // 获取数组参数
    tags := ctx.URLParamsSlice("tags")
    categories := ctx.URLParamsSlice("categories")
    
    ctx.JSON(iris.Map{
        "tags":       tags,
        "categories": categories,
    })
})
```

## 路由组

### 1. 基本路由组

```go
// 创建路由组
api := app.Party("/api")
{
    api.Get("/", func(ctx iris.Context) {
        ctx.WriteString("API 根路径")
    })
    
    api.Get("/users", func(ctx iris.Context) {
        ctx.WriteString("用户列表")
    })
    
    api.Post("/users", func(ctx iris.Context) {
        ctx.WriteString("创建用户")
    })
}

// 嵌套路由组
v1 := app.Party("/api/v1")
{
    users := v1.Party("/users")
    {
        users.Get("/", getUsers)
        users.Post("/", createUser)
        users.Get("/{id:int}", getUser)
        users.Put("/{id:int}", updateUser)
        users.Delete("/{id:int}", deleteUser)
    }
    
    posts := v1.Party("/posts")
    {
        posts.Get("/", getPosts)
        posts.Post("/", createPost)
    }
}
```

### 2. 路由组中间件

```go
// 为路由组添加中间件
api := app.Party("/api")
api.Use(authMiddleware)        // 所有 API 路由都使用认证中间件
api.Use(loggingMiddleware)     // 所有 API 路由都使用日志中间件

{
    api.Get("/public", publicHandler)
    
    // 子路由组可以有自己的中间件
    admin := api.Party("/admin")
    admin.Use(adminMiddleware)   // 只有管理员路由需要管理员中间件
    {
        admin.Get("/users", adminUsersHandler)
        admin.Post("/settings", adminSettingsHandler)
    }
}
```

## 路由命名

### 1. 命名路由

```go
// 命名路由
app.Get("/users/{id:int}", getUserHandler).Name = "user.detail"

// 使用 Name 方法命名
app.Get("/posts/{id:int}", getPostHandler).Name = "post.detail"

// 获取路由 URL
url, err := app.GetRoute("user.detail").URL(iris.Params{"id": "123"})
if err == nil {
    fmt.Println("用户详情 URL:", url.String())
}
```

### 2. 路由信息获取

```go
// 获取所有路由
routes := app.GetRoutes()
for _, route := range routes {
    fmt.Printf("方法: %s, 路径: %s, 名称: %s\n", 
        route.Method, route.Path, route.Name)
}
```

## 条件路由

### 1. 基于条件的路由

```go
// 基于主机名的路由
app.Subdomain("admin.").Get("/", func(ctx iris.Context) {
    ctx.WriteString("管理员面板")
})

// 基于协议的路由
app.Get("/secure", func(ctx iris.Context) {
    if !ctx.IsSSL() {
        ctx.Redirect("https://" + ctx.Host() + ctx.Path())
        return
    }
    ctx.WriteString("安全页面")
})
```

## 路由优先级

### 1. 路由匹配顺序

Iris 按照注册顺序匹配路由，更具体的路由应该先注册：

```go
// 正确的路由注册顺序
app.Get("/users/{id:int}", getUserHandler)      // 具体路由
app.Get("/users/new", newUserHandler)           // 具体路由
app.Get("/users/{name:string}", getUserByName)  // 通用路由

// 错误的顺序（会导致 /users/new 被当作参数路由处理）
app.Get("/users/{name:string}", getUserByName)   // 通用路由
app.Get("/users/new", newUserHandler)           // 永远不会匹配
```

## 静态文件路由

### 1. 基本静态文件服务

```go
// 服务静态文件
app.HandleDir("/static", iris.Dir("./static"))

// 服务多个静态目录
app.HandleDir("/assets", iris.Dir("./assets"))
app.HandleDir("/uploads", iris.Dir("./uploads"))
```

### 2. 静态文件配置

```go
// 配置静态文件服务
app.HandleDir("/static", iris.Dir("./static"), iris.DirOptions{
    IndexName: "index.html",
    Gzip:      true,
    ShowList:  false,
    Cache: iris.DirCacheOptions{
        Compress: true,
        Encodings: []string{"gzip", "deflate"},
    },
})
```

## 路由示例

### 1. RESTful API 示例

```go
// 完整的 RESTful API 路由示例
func setupAPIRoutes(app *iris.Application) {
    api := app.Party("/api/v1")
    api.Use(corsMiddleware)
    api.Use(loggingMiddleware)

    // 用户资源
    users := api.Party("/users")
    {
        users.Get("/", getUsersList)           // GET /api/v1/users
        users.Post("/", createUser)            // POST /api/v1/users
        users.Get("/{id:int}", getUser)        // GET /api/v1/users/123
        users.Put("/{id:int}", updateUser)     // PUT /api/v1/users/123
        users.Patch("/{id:int}", patchUser)    // PATCH /api/v1/users/123
        users.Delete("/{id:int}", deleteUser)  // DELETE /api/v1/users/123
        
        // 用户相关资源
        users.Get("/{id:int}/posts", getUserPosts)     // GET /api/v1/users/123/posts
        users.Post("/{id:int}/posts", createUserPost)  // POST /api/v1/users/123/posts
    }

    // 文章资源
    posts := api.Party("/posts")
    {
        posts.Get("/", getPostsList)          // GET /api/v1/posts
        posts.Post("/", createPost)           // POST /api/v1/posts
        posts.Get("/{id:int}", getPost)       // GET /api/v1/posts/123
        posts.Put("/{id:int}", updatePost)    // PUT /api/v1/posts/123
        posts.Delete("/{id:int}", deletePost) // DELETE /api/v1/posts/123
        
        // 文章评论
        posts.Get("/{id:int}/comments", getPostComments)    // GET /api/v1/posts/123/comments
        posts.Post("/{id:int}/comments", createComment)    // POST /api/v1/posts/123/comments
    }
}
```

### 2. 复杂路由示例

```go
// 复杂的路由处理示例
func setupComplexRoutes(app *iris.Application) {
    // 多语言支持
    app.Get("/{lang:alphabetical}/home", func(ctx iris.Context) {
        lang := ctx.Params().GetString("lang")
        ctx.WriteString("首页 - 语言: " + lang)
    })

    // API 版本控制
    v1 := app.Party("/api/v1")
    v2 := app.Party("/api/v2")
    
    setupAPIVersion(v1, "v1")
    setupAPIVersion(v2, "v2")

    // 条件路由 - 基于用户角色
    app.Get("/dashboard", func(ctx iris.Context) {
        userRole := getUserRole(ctx) // 获取用户角色
        
        switch userRole {
        case "admin":
            ctx.Redirect("/admin/dashboard")
        case "user":
            ctx.Redirect("/user/dashboard")
        default:
            ctx.Redirect("/login")
        }
    })
}

func setupAPIVersion(api iris.Party, version string) {
    api.Get("/", func(ctx iris.Context) {
        ctx.WriteString("API " + version)
    })
}
```

## 路由测试

### 1. 单元测试路由

```go
func TestUserRoutes(t *testing.T) {
    app := iris.New()
    setupUserRoutes(app)

    // 测试获取用户列表
    e := httptest.New(t, app)
    e.GET("/api/users").Expect().Status(iris.StatusOK)
    
    // 测试获取单个用户
    e.GET("/api/users/1").Expect().Status(iris.StatusOK)
    
    // 测试创建用户
    e.POST("/api/users").WithJSON(map[string]string{
        "name":  "Test User",
        "email": "test@example.com",
    }).Expect().Status(iris.StatusCreated)
}
```

## 最佳实践

### 1. 路由组织

- 按功能模块组织路由
- 使用路由组管理相关路由
- 为路由添加有意义的名称
- 保持路由简洁和语义化

### 2. 参数验证

```go
app.Get("/users/{id:int}", func(ctx iris.Context) {
    id, err := ctx.Params().GetInt("id")
    if err != nil {
        ctx.StatusCode(iris.StatusBadRequest)
        ctx.JSON(iris.Map{"error": "无效的用户ID"})
        return
    }
    
    if id <= 0 {
        ctx.StatusCode(iris.StatusBadRequest)
        ctx.JSON(iris.Map{"error": "用户ID必须大于0"})
        return
    }
    
    // 处理逻辑...
})
```

### 3. 错误处理

```go
// 统一的错误处理
func handleUserError(ctx iris.Context, err error) {
    if err == ErrUserNotFound {
        ctx.StatusCode(iris.StatusNotFound)
        ctx.JSON(iris.Map{"error": "用户不存在"})
    } else if err == ErrInvalidInput {
        ctx.StatusCode(iris.StatusBadRequest)
        ctx.JSON(iris.Map{"error": "输入数据无效"})
    } else {
        ctx.StatusCode(iris.StatusInternalServerError)
        ctx.JSON(iris.Map{"error": "服务器内部错误"})
    }
}
```

## 下一步

现在您已经掌握了 Iris 的路由系统，建议继续学习：

1. [中间件使用](./03-中间件使用.md) - 学习如何使用和编写中间件
2. [请求处理](./04-请求处理.md) - 深入了解请求处理机制
3. [响应处理](./05-响应处理.md) - 掌握各种响应格式

## 相关资源

- [Iris 路由文档](https://iris-go.com/routing)
- [HTTP 方法参考](https://developer.mozilla.org/en-US/docs/Web/HTTP/Methods)
- [RESTful API 设计指南](https://restfulapi.net/)